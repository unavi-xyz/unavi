name: terraform
on:
  workflow_dispatch:
    inputs:
      action:
        description: "terraform action"
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan
jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: install nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: setup nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: terraform init
        working-directory: infra/terraform
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          SPACES_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
        run: nix develop --command terraform init
      - name: terraform plan
        working-directory: infra/terraform
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          SPACES_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
        run: |
          nix develop --command terraform plan -out=tfplan
          nix develop --command terraform show -no-color tfplan > plan.txt
      - name: upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/plan.txt
      - name: terraform apply
        if: github.event.inputs.action == 'apply'
        working-directory: infra/terraform
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          SPACES_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          SPACES_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
        run: nix develop --command terraform apply tfplan
